
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pisces.models.base &#8212; Pisces  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pisces/models/base';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Pisces  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../reference/index.html">
    Pisces User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../examples.html">
    Examples
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../reference/index.html">
    Pisces User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../examples.html">
    Examples
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">pisces.models.base</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for pisces.models.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Pisces astrophysics modeling base classes.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">unyt</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">ArrayLike</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">InterpolatedUnivariateSpline</span>

<span class="kn">from</span> <span class="nn">pisces.geometry</span> <span class="kn">import</span> <span class="n">GeometryHandler</span>
<span class="kn">from</span> <span class="nn">pisces.geometry.base</span> <span class="kn">import</span> <span class="n">CoordinateSystem</span>
<span class="kn">from</span> <span class="nn">pisces.geometry.coordinate_systems</span> <span class="kn">import</span> <span class="n">SphericalCoordinateSystem</span>
<span class="kn">from</span> <span class="nn">pisces.io.hdf5</span> <span class="kn">import</span> <span class="n">HDF5_File_Handle</span>
<span class="kn">from</span> <span class="nn">pisces.models.grids.base</span> <span class="kn">import</span> <span class="n">ModelGridManager</span>
<span class="kn">from</span> <span class="nn">pisces.models.solver</span> <span class="kn">import</span> <span class="n">ModelSolver</span>
<span class="kn">from</span> <span class="nn">pisces.models.utilities</span> <span class="kn">import</span> <span class="n">ModelConfigurationDescriptor</span>
<span class="kn">from</span> <span class="nn">pisces.profiles.base</span> <span class="kn">import</span> <span class="n">Profile</span>
<span class="kn">from</span> <span class="nn">pisces.profiles.collections</span> <span class="kn">import</span> <span class="n">HDF5ProfileRegistry</span>
<span class="kn">from</span> <span class="nn">pisces.utilities.logging</span> <span class="kn">import</span> <span class="n">LogDescriptor</span><span class="p">,</span> <span class="n">devlog</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">Logger</span>

    <span class="kn">from</span> <span class="nn">matplotlib.axes</span> <span class="kn">import</span> <span class="n">Axes</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>

    <span class="kn">from</span> <span class="nn">pisces.models.grids.base</span> <span class="kn">import</span> <span class="n">ModelField</span><span class="p">,</span> <span class="n">ModelFieldContainer</span>
    <span class="kn">from</span> <span class="nn">pisces.utilities.config</span> <span class="kn">import</span> <span class="n">YAMLConfig</span>


<span class="c1"># noinspection PyProtectedMember</span>
<div class="viewcode-block" id="ModelMeta">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.ModelMeta.html#pisces.models.base.ModelMeta">[docs]</a>
<span class="k">class</span> <span class="nc">ModelMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metaclass that inspects class attributes for solver-related metadata and constructs</span>
<span class="sd">    the internal ``_PATHWAYS`` dictionary on the resulting class. This dictionary is used</span>
<span class="sd">    by the solver to coordinate processes and checkers for each solver pathway.</span>

<span class="sd">    .. note::</span>

<span class="sd">       This metaclass is intended for use within the :py:class:`~pisces.models.base.Model`</span>
<span class="sd">       inheritance chain. It looks for methods marked with solver decorators (e.g.</span>
<span class="sd">       :py:func:`~pisces.models.solver.solver_process` and :py:func:`~pisces.models.solver.solver_checker`)</span>
<span class="sd">       and builds a structured description of each pathway, including:</span>

<span class="sd">       - A dictionary of process steps (indexed by step number).</span>
<span class="sd">       - A list of checker functions.</span>

<span class="sd">    **Key Steps**:</span>

<span class="sd">    1. **Collect** metadata from each decorated class method (methods that contain</span>
<span class="sd">       a :py:attr:`_solver_meta` attribute).</span>
<span class="sd">    2. **Partition** the methods by their declared pathway (``_solver_meta[&quot;path&quot;]``).</span>
<span class="sd">    3. **Organize** them by type:</span>
<span class="sd">       - ``process`` entries (with a ``step``, ``args``, ``kwargs``, etc.)</span>
<span class="sd">       - ``checker`` entries (added to a list).</span>
<span class="sd">    4. **Validate** the integrity of these definitions (unique step numbers, valid types, etc.).</span>
<span class="sd">    5. **Store** the final pathways dictionary on the class as ``_PATHWAYS``.</span>

<span class="sd">    When a :py:class:`~pisces.models.solver.ModelSolver` (or similar) is later</span>
<span class="sd">    attached to the model, it can inspect ``_PATHWAYS`` to discover which processes</span>
<span class="sd">    and checkers to run in which order.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span>
        <span class="n">mcs</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;ModelMeta&quot;</span><span class="p">],</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">bases</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">clsdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new class object, searching for solver metadata in ``clsdict`` and</span>
<span class="sd">        building a ``_PATHWAYS`` attribute on the new class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mcs : type</span>
<span class="sd">            The metaclass (this class).</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the class being created (e.g., &quot;MyModel&quot;).</span>
<span class="sd">        bases : tuple</span>
<span class="sd">            The base classes for this new class.</span>
<span class="sd">        clsdict : dict</span>
<span class="sd">            The class attributes namespace (methods, class variables, etc.).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            The newly created class with the ``_PATHWAYS`` attribute populated or empty if the class is abstract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Identify if the class is abstract or concrete. This step is necessary so that</span>
        <span class="c1"># we don&#39;t force abstract classes to have properties which are not necessary given</span>
        <span class="c1"># that they are never instantiated.</span>
        <span class="n">is_abstract</span> <span class="o">=</span> <span class="n">clsdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_IS_ABC&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Create the base class object without adulteration from the</span>
        <span class="c1"># metaclass.</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">)</span>

        <span class="c1"># If the class is not an abstract base class, we need to construct the pathways</span>
        <span class="c1"># dictionary. Otherwise, we leave the entire dictionary blank.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_abstract</span><span class="p">:</span>
            <span class="n">mcs</span><span class="o">.</span><span class="n">construct_pathways</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span>

<div class="viewcode-block" id="ModelMeta.construct_pathways">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.ModelMeta.construct_pathways.html#pisces.models.base.ModelMeta.construct_pathways">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">construct_pathways</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="s2">&quot;ModelMeta&quot;</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the `_PATHWAYS` dictionary for a concrete (non-abstract) class by scanning all</span>
<span class="sd">        attributes (including inherited ones) for solver metadata.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls :</span>
<span class="sd">            The class that is being constructed (i.e. the one with this metaclass).</span>
<span class="sd">        clsdict : dict</span>
<span class="sd">            The dictionary of attributes defined specifically on this class (not bases).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any method is flagged incorrectly (e.g., missing a step for a process, or invalid type),</span>
<span class="sd">            or if there are duplicate steps within a pathway.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We&#39;ll iterate over the class&#39;s entire MRO, collecting solver metadata from each base class as well.</span>
        <span class="c1"># This ensures that inherited methods with solver decorators are included.</span>
        <span class="n">seen_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">inherits_pathways</span> <span class="o">=</span> <span class="n">clsdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_INHERITS_PATHWAYS&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inherits_pathways</span><span class="p">:</span>
            <span class="n">bases</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bases</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="c1"># The built-in `object` or other sentinel classes won&#39;t contain relevant solver info.</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="nb">object</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Explore the base&#39;s __dict__ to find candidate methods/attributes.</span>
            <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">method_obj</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Make sure we don&#39;t re-process the same (base, attr_name) combination.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen_attrs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seen_attrs</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">))</span>

                <span class="c1"># Now see if it has solver metadata.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method_obj</span><span class="p">,</span> <span class="s2">&quot;_solver_meta&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># For each solver meta record on that method, register it appropriately.</span>
                <span class="k">for</span> <span class="n">meta_record</span> <span class="ow">in</span> <span class="n">method_obj</span><span class="o">.</span><span class="n">_solver_meta</span><span class="p">:</span>
                    <span class="n">path_name</span><span class="p">,</span> <span class="n">entry_type</span> <span class="o">=</span> <span class="n">ModelMeta</span><span class="o">.</span><span class="n">_validate_meta_entry</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span> <span class="n">method_obj</span><span class="p">,</span> <span class="n">meta_record</span>
                    <span class="p">)</span>

                    <span class="c1"># Ensure that there&#39;s an entry for `path_name`.</span>
                    <span class="k">if</span> <span class="n">path_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">:</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">[</span><span class="n">path_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;processes&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;checkers&quot;</span><span class="p">:</span> <span class="p">[]}</span>

                    <span class="k">if</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="s2">&quot;process&quot;</span><span class="p">:</span>
                        <span class="n">ModelMeta</span><span class="o">.</span><span class="n">_add_process_to_pathways</span><span class="p">(</span>
                            <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span>
                            <span class="n">attribute_name</span><span class="o">=</span><span class="n">attr_name</span><span class="p">,</span>
                            <span class="n">method</span><span class="o">=</span><span class="n">method_obj</span><span class="p">,</span>
                            <span class="n">meta_record</span><span class="o">=</span><span class="n">meta_record</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="s2">&quot;checker&quot;</span><span class="p">:</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">[</span><span class="n">path_name</span><span class="p">][</span><span class="s2">&quot;checkers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>

        <span class="c1"># Finally, validate that the constructed `_PATHWAYS` is coherent, e.g. steps are contiguous.</span>
        <span class="n">ModelMeta</span><span class="o">.</span><span class="n">_validate_pathways</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_process_to_pathways</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="s2">&quot;ModelMeta&quot;</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">meta_record</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a new &quot;process&quot; entry into the `_PATHWAYS` dictionary for a specific path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls :</span>
<span class="sd">            The class that is being constructed. Accesses `cls._PATHWAYS`.</span>
<span class="sd">        attribute_name : str</span>
<span class="sd">            The method name as it appears on the class.</span>
<span class="sd">        method : Any</span>
<span class="sd">            The actual method object (callable).</span>
<span class="sd">        meta_record : Dict[str, Any]</span>
<span class="sd">            The metadata dict. Must contain `path`, `step`, `args`, `kwargs`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no `step` is provided, or if `step` is already used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_name</span> <span class="o">=</span> <span class="n">meta_record</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
        <span class="n">step_no</span> <span class="o">=</span> <span class="n">meta_record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step_no</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Method &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; is declared as a &#39;process&#39; but has no &#39;step&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Check your solver_process decorator usage.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ensure we haven&#39;t used this step in the same path already.</span>
        <span class="k">if</span> <span class="n">step_no</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">[</span><span class="n">path_name</span><span class="p">][</span><span class="s2">&quot;processes&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Duplicate step &#39;</span><span class="si">{</span><span class="n">step_no</span><span class="si">}</span><span class="s2">&#39; found in path &#39;</span><span class="si">{</span><span class="n">path_name</span><span class="si">}</span><span class="s2">&#39; for method &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Extract any user-specified arguments for the method call.</span>
        <span class="n">process_args</span> <span class="o">=</span> <span class="n">meta_record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">process_kwargs</span> <span class="o">=</span> <span class="n">meta_record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Prepare a short docstring as &quot;desc&quot;.</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">ModelMeta</span><span class="o">.</span><span class="n">_process_attribute_description</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">[</span><span class="n">path_name</span><span class="p">][</span><span class="s2">&quot;processes&quot;</span><span class="p">][</span><span class="n">step_no</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">attribute_name</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">process_args</span><span class="p">,</span>
            <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">process_kwargs</span><span class="p">,</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_meta_entry</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">meta_record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate a single metadata record to ensure it has the needed keys.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attribute_name : str</span>
<span class="sd">            The method name as it appears on the class.</span>
<span class="sd">        meta_record : dict</span>
<span class="sd">            The dictionary containing the solver metadata for this method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A 2-tuple of `(path_name, entry_type)`, where `entry_type` is &quot;process&quot; or &quot;checker&quot;.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If there&#39;s no `path` in the record, or the `type` is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_name</span> <span class="o">=</span> <span class="n">meta_record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
        <span class="n">entry_type</span> <span class="o">=</span> <span class="n">meta_record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Method &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; is missing a &#39;path&#39; in its solver metadata. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Likely a misconfigured or incomplete solver decorator.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">entry_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;checker&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Method &#39;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&#39; includes an unsupported type &#39;</span><span class="si">{</span><span class="n">entry_type</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected &#39;process&#39; or &#39;checker&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">path_name</span><span class="p">,</span> <span class="n">entry_type</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_process_attribute_description</span><span class="p">(</span><span class="n">method_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a single-line docstring summary from the method object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method_obj : Any</span>
<span class="sd">            Typically a callable that might have a `__doc__` attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The first line of the docstring, stripped of leading/trailing whitespace,</span>
<span class="sd">            or &quot;No Description.&quot; if no docstring is present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method_obj</span><span class="p">,</span> <span class="s2">&quot;__doc__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No Description.&quot;</span>

        <span class="c1"># Remove leading newlines/spaces; then take the first line.</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">first_line</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">first_line</span> <span class="k">if</span> <span class="n">first_line</span> <span class="k">else</span> <span class="s2">&quot;No Description.&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_pathways</span><span class="p">(</span><span class="n">pathways</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure all process steps in each pathway form a contiguous range [0..N-1].</span>
<span class="sd">        If not, raises a ValueError.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pathways : Dict[str, Dict[str, Any]]</span>
<span class="sd">            A dictionary of the form:</span>
<span class="sd">               {</span>
<span class="sd">                 &quot;cooling_flow&quot;: {</span>
<span class="sd">                   &quot;processes&quot;: { 0: {...}, 1: {...}, ... },</span>
<span class="sd">                   &quot;checkers&quot;: [...]</span>
<span class="sd">                 },</span>
<span class="sd">                 ...</span>
<span class="sd">               }</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If a pathway&#39;s steps are missing or non-contiguous.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">path_name</span><span class="p">,</span> <span class="n">path_data</span> <span class="ow">in</span> <span class="n">pathways</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">process_steps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">path_data</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c1"># E.g., if we have steps [0, 1, 3], we detect the gap at &#39;2&#39;.</span>
            <span class="k">if</span> <span class="n">process_steps</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">process_steps</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Pathway &#39;</span><span class="si">{</span><span class="n">path_name</span><span class="si">}</span><span class="s2">&#39; has missing or non-contiguous steps: </span><span class="si">{</span><span class="n">process_steps</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span></div>



<span class="c1"># noinspection PyAttributeOutsideInit,PyUnresolvedReferences</span>
<div class="viewcode-block" id="Model">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.html#pisces.models.base.Model">[docs]</a>
<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ModelMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for physical models in Pisces.</span>

<span class="sd">    .. tip::</span>

<span class="sd">        For detailed information on basic use of the :py:class:`Model` class, see :ref:`modeling_overview`.</span>

<span class="sd">    The :py:class:`Model` provides a flexible framework for managing grid data, profiles, and solution workflows</span>
<span class="sd">    (pathways) for physical models (which are subclasses of this base class). At the core, the :py:class:`Model` has</span>
<span class="sd">    3 critical pieces of infrastructure:</span>

<span class="sd">    1. The **grid management** system (orchestrated by a :py:class:`~pisces.models.grids.base.ModelGridManager`) controls</span>
<span class="sd">       the physical domain of the model, the coordinate system for the model, and manages the storing / retrieving of fields</span>
<span class="sd">       containing the physical data of the model.</span>

<span class="sd">       You can access the grid manager via :py:attr:`grid_manager`, and the constituent fields which form the core</span>
<span class="sd">       of the model are accessed either via ``self.grid_manager.FIELDS` or (equivalently) :py:attr:`FIELDS`.</span>

<span class="sd">       .. note::</span>

<span class="sd">            In general, the :py:attr:`grid_manager` handles a lot of backend tasks for you. It&#39;s rarely necessary for a</span>
<span class="sd">            standard user to interact directly with it. For developers, it is where the core logic of the model is. Most importantly,</span>
<span class="sd">            the grid manager controls where and how data is stored, accessed, and manipulated in models.</span>

<span class="sd">    2. The **profiles** (:py:attr:`profiles`) are standard Pisces profiles (:py:class:`~pisces.profiles.base.Profile`) which</span>
<span class="sd">       are registered directly to the model. This allows for persistent access to them even when loading a model from disk.</span>

<span class="sd">    3. The **solver** system (orchestrated by a :py:class:`~pisces.models.solver.ModelSolver`) controls how the model is populated</span>
<span class="sd">       with data.</span>

<span class="sd">       .. tip::</span>

<span class="sd">            For standard users, this is the most important part of the whole system!</span>

<span class="sd">       Every :py:class:`Model` subclass has a set of so-called &quot;pathways&quot;, which tell the class how to take an empty &quot;skeleton&quot; of</span>
<span class="sd">       the model to a fully realized, &quot;solved,&quot; model. When you call the model (``model.solve_model()`` or ``model()``), the model</span>
<span class="sd">       instance attempts to execute one of these &quot;pathways&quot;, proceeding in order through the procedures contained in the pathway.</span>

<span class="sd">       This allows for models to setup modular physics routines (to solve the Poisson Equation, manipulate equations of state, etc.)</span>
<span class="sd">       which can then be connected together to form a pathway which &quot;solves&quot; the model.</span>

<span class="sd">       .. note::</span>

<span class="sd">            Models may have several pathways! You can see the list of available pathways using the :py:meth:`list_pathways` method,</span>
<span class="sd">            and you can access details about the pathways using the :py:meth:`get_pathway` method. When you run your model, you</span>
<span class="sd">            can specify the ``pathway=`` argument to select a pathway to run.</span>

<span class="sd">       .. important::</span>

<span class="sd">            Pathways in models are not always accessible. They may rely on specific pieces of data which are present</span>
<span class="sd">            only in some cases or they may be specific to a certain case / parameter choice. Before running, every pathway</span>
<span class="sd">            calls a **validation** method to check if its permitted given the data available in the model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># @@ VALIDATION MARKERS @@ #</span>
    <span class="c1"># These validation markers are used by the Model to constrain the valid</span>
    <span class="c1"># parameters for the model. Subclasses can modify the validation markers</span>
    <span class="c1"># to constrain coordinate system compatibility.</span>
    <span class="c1">#</span>
    <span class="c1"># : _IS_ABC : marks whether the model should seek out pathways or not.</span>
    <span class="c1"># : _INHERITS_PATHWAYS: will allow subclasses to inherit the pathways of their parent class.</span>
    <span class="n">_IS_ABC</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_INHERITS_PATHWAYS</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># @@ CLASS PARAMETERS @@ #</span>
    <span class="c1"># The class parameters define several &quot;standard&quot; behaviors for the class.</span>
    <span class="c1"># These can be altered in subclasses to produce specific behaviors.</span>
    <span class="n">DEFAULT_COORDINATE_SYSTEM</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">CoordinateSystem</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; :py:class:`~pisces.geometry.base.CoordinateSystem`: The default coordinate system.</span>

<span class="sd">    If a :py:class:`Model` skeleton is produced (either during ``__init__`` or during :py:meth:`Model.build_skeleton`) and</span>
<span class="sd">    a coordinate system is not provided, the default coordinate system will be used. The parameters (if any) used to</span>
<span class="sd">    generate the default coordinate system are provided by :py:attr:`Model.DEFAULT_COORDINATE_SYSTEM_PARAMS`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If :py:attr:`DEFAULT_COORDINATE_SYSTEM` is ``None``, then there is no default coordinate system and an</span>
<span class="sd">        error is raised if the user does not provide a coordinate system during the build process.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_COORDINATE_SYSTEM_PARAMS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; dict of str, Any: The parameters for the default coordinate system.</span>

<span class="sd">    These parameters (if any) are passed to :py:attr:`Model.DEFAULT_COORDINATE_SYSTEM` during the build process if</span>
<span class="sd">    the default coordinate system is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">INIT_FREE_AXES</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; list of str: The model class&#39;s initial non-symmetric (free) axes.</span>
<span class="sd">    By specifying the :py:attr:`INIT_FREE_AXES` attribute, model developers may dictate the behavior of the</span>
<span class="sd">    :py:attr:`geometry_handler` attribute of any model instances.</span>

<span class="sd">    The idea behind this class-attribute is that specific models may have some &quot;minimal symmetry&quot; (i.e. galaxy cluster models</span>
<span class="sd">    which assume radial profile inputs). In these cases, even the blank :py:class:`Model` instance starts with some native</span>
<span class="sd">    symmetry mediated via the :py:attr:`geometry_handler` attribute.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If ``INIT_FREE_AXES = None``, then it is assumed that all axes are free at baseline (there is no symmetry).</span>

<span class="sd">    .. tip::</span>

<span class="sd">        **For Developers**: Best practice regarding the :py:class:`Model` geometry handler depends largely on the desired</span>
<span class="sd">        behavior. In cases where pathways make frequent use of some &quot;baseline symmetry&quot;, it may be worthwhile to implement this.</span>
<span class="sd">        If not, it can generally be left as ``None``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GRID_MANAGER_TYPE</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ModelGridManager</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelGridManager</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Type[:py:class:`~pisces.models.grids.base.ModelGridManager`]: The grid manager type to use to manage this model class.</span>

<span class="sd">    The selected :py:class:`~pisces.models.grids.base.ModelGridManager` is the grid manager type that is used to manage this</span>
<span class="sd">    model class&#39;s grid structures. Implementing a custom grid manager class specific to particular model constraints is made</span>
<span class="sd">    possible by altering this attribute of the model class to point to the custom manager class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="p">:</span> <span class="s2">&quot;Logger&quot;</span> <span class="o">=</span> <span class="n">LogDescriptor</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Logger: The specialized logger for this model class.</span>

<span class="sd">    This specialized logger is controlled by the ``code``-type logger settings in the ``bin/config.yaml`` file. This allows</span>
<span class="sd">    the user to ensure that output from the model generation is turned off / on regardless of the behavior of the other</span>
<span class="sd">    logging systems in the Pisces ecosystem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;YAMLConfig&quot;</span> <span class="o">=</span> <span class="n">ModelConfigurationDescriptor</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; :py:class:`~pisces.utilities.config.YAMLConfig`: The configuration data for this model class.</span>

<span class="sd">    The configuration file provides access to things like field data, units, symbols, etc. for use throughout</span>
<span class="sd">    the model construction. If a configuration file is not specified, these utilities will not function when called.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># @@ LOADING METHODS @@ #</span>
    <span class="c1"># These methods form the core of the loading procedures for</span>
    <span class="c1"># models. Subclasses may overwrite these where necessary; however,</span>
    <span class="c1"># it is generally possible to leave the core of __init__ alone.</span>
<div class="viewcode-block" id="Model.__init__">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.__init__.html#pisces.models.base.Model.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the :py:class:`Model` instance by loading from an HDF5 file.</span>

<span class="sd">        .. tip::</span>

<span class="sd">            Using ``__init__`` to load a :py:class:`Model` from disk is generally the best approach</span>
<span class="sd">            when you have an existing model. Otherwise, you may want to use a class method which directs</span>
<span class="sd">            the solution process to occur on creation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str or Path</span>
<span class="sd">            The file path to the HDF5 file representing the model. If the path does not</span>
<span class="sd">            exist, an exception is raised.</span>

<span class="sd">            .. note::</span>

<span class="sd">                The specified path must point to a valid :py:class:`Model` instance on disk. If it does not,</span>
<span class="sd">                any number of exceptions may be raised due to incorrect data types and other issues.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the specified path does not exist or is invalid.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the profile registry cannot be loaded.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        **Initialization Procedure**:</span>

<span class="sd">        Generally, the initialization procedure occurs in the following order:</span>

<span class="sd">        1. Load the HDF5 file containing the model data.</span>
<span class="sd">        2. Initialize the grid manager to handle spatial grid operations.</span>
<span class="sd">        3. Validate the coordinate system to ensure compatibility with the model.</span>
<span class="sd">        4. Load profiles from the HDF5 file.</span>
<span class="sd">        5. Initialize the solver for executing computation pathways.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pull the user&#39;s provided path and ensure that it exists.</span>
        <span class="c1"># We do not permit non-existent paths to proceed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># -&gt; private to use property instead.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to find path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[LOAD] Loading model from file: </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>

        <span class="c1"># Load the components of the Model from disk.</span>
        <span class="c1"># There are 3 constituent attributes to generate:</span>
        <span class="c1">#   1. The grid manager.</span>
        <span class="c1">#      This includes an additional validation step.</span>
        <span class="c1">#   2. Profiles.</span>
        <span class="c1">#   3. The solver.</span>
        <span class="c1">#</span>
        <span class="c1"># =&gt; Start with the grid manager / coordinate system.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_handler</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># --&gt; holds the lazy loaded geometry handler.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">GRID_MANAGER_TYPE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_coordinate_system</span><span class="p">()</span>
        <span class="n">devlog</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(model load) got manager: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="p">)</span>
        <span class="n">devlog</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;(model load) got coordinate_system: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">coordinate_system</span>
        <span class="p">)</span>

        <span class="c1"># =&gt; Load the profiles into the collection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_profiles</span><span class="p">()</span>
        <span class="n">devlog</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(model load) got profiles: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># =&gt; Load the solver.</span>
        <span class="c1"># This is always a simple ModelSolver (the solver class is really simple).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="n">ModelSolver</span><span class="o">.</span><span class="n">from_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">devlog</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(model load) got solver: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">)</span>

        <span class="c1"># Log output to standard log so users can see that the</span>
        <span class="c1"># load completed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[LOAD] COMPLETE: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_load_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the profile registry from the HDF5 file.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the profile registry cannot be loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">profiles_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;PROFILES&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span> <span class="o">=</span> <span class="n">HDF5ProfileRegistry</span><span class="p">(</span><span class="n">profiles_handle</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to load profile registry.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

<div class="viewcode-block" id="Model.build_skeleton">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.build_skeleton.html#pisces.models.base.Model.build_skeleton">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_skeleton</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">bbox</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">grid_shape</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">chunk_shape</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">length_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">profiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Profile&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">coordinate_system</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoordinateSystem</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HDF5_File_Handle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a &quot;skeleton&quot; for the :py:class:`Model` class.</span>

<span class="sd">        The skeleton is the base structure necessary to load an HDF5 file as this object. This includes the following basic</span>
<span class="sd">        structures:</span>

<span class="sd">        - The :py:class:`~pisces.models.grids.base.ModelGridManager` instance, which controls the grids and data storage.</span>
<span class="sd">        - The :py:class:`~pisces.profiles.collections.HDF5ProfileRegistry` instance, which acts as a container for the user</span>
<span class="sd">          provided profiles.</span>

<span class="sd">        .. important::</span>

<span class="sd">            In general use, the :py:meth:`build_skeleton` method should only rarely be called. When generating a model subclass</span>
<span class="sd">            for a particular physical system, the user should generate the model by calling a &quot;generator&quot; method of the class. The</span>
<span class="sd">            generator method then performs some basic setup tasks before passing a more constrained set of arguments to the</span>
<span class="sd">            :py:meth:`build_skeleton` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str or Path</span>
<span class="sd">            The path at which to build the skeleton for the model. If a file already exists at ``path``, then an error</span>
<span class="sd">            is raised unless ``overwrite=True``. If ``overwrite=True``, then the original file is deleted and the new skeleton</span>
<span class="sd">            will take its place.</span>
<span class="sd">        bbox : NDArray[np.float64], optional</span>
<span class="sd">            The bounding box that defines the physical extent of the grid in each axis. This should be convertible into</span>
<span class="sd">            a :py:class:`~pisces.models.grids.structs.BoundingBox`, with shape ``(2, NDIM)``, where ``NDIM`` matches</span>
<span class="sd">            the number of axes in ``coordinate_system``. The first row contains the minimum coordinate</span>
<span class="sd">            values along each axis, and the second row contains the maximum coordinate values.</span>

<span class="sd">            .. note::</span>

<span class="sd">               You can provide this in a Python list form such as ``[[x0_min, x0_max],</span>
<span class="sd">               [x1_min, x1_max], ...]``.</span>

<span class="sd">        grid_shape : NDArray[np.int64], optional</span>
<span class="sd">            The shape of the grid, specifying the number of cells along each axis. It should be a 1D array-like of</span>
<span class="sd">            integers with length equal to the number of dimensions in</span>
<span class="sd">            ``coordinate_system``.</span>

<span class="sd">        chunk_shape : NDArray[np.int64], optional</span>
<span class="sd">            The shape of each chunk used for subdividing the grid, allowing chunk-based</span>
<span class="sd">            operations or partial in-memory loading.</span>

<span class="sd">            If not provided, it defaults to</span>
<span class="sd">            ``grid_shape``, meaning the entire grid is treated as a single chunk. If specified,</span>
<span class="sd">            each element must divide the corresponding element in ``grid_shape`` without</span>
<span class="sd">            remainder.</span>

<span class="sd">            .. important::</span>

<span class="sd">                The choice to perform operations in chunks (or not to) is made by the developer of</span>
<span class="sd">                the relevant model. Generally, if it isn&#39;t necessary to perform operations in chunks, it&#39;s avoided.</span>
<span class="sd">                As such, it&#39;s generally advisable to leave this argument unchanged unless you have a clear reason</span>
<span class="sd">                to set it.</span>

<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If True, overwrite any existing file at the specified path. If False and the</span>
<span class="sd">            file exists, an exception will be raised. Defaults to False.</span>
<span class="sd">        length_unit : str, optional</span>
<span class="sd">            The physical length unit for interpreting grid coordinates, for example `&quot;kpc&quot;`</span>
<span class="sd">            or `&quot;cm&quot;`. Defaults to the :py:attr:`DEFAULT_LENGTH_UNIT` of this model class&#39;s :py:attr:`GRID_MANAGER_TYPE`.</span>

<span class="sd">        scale : Union[List[str], str], optional</span>
<span class="sd">            The scaling mode for each axis, determining whether cells are spaced linearly or</span>
<span class="sd">            logarithmically. Each entry can be `&quot;linear&quot;` or `&quot;log&quot;`. If a single string is given,</span>
<span class="sd">            it is applied to all axes. Defaults to the :py:attr:`DEFAULT_SCALE` of this model class&#39;s :py:attr:`GRID_MANAGER_TYPE`.</span>

<span class="sd">        profiles : dict[str, :py:class:`~pisces.profiles.base.Profile`], optional</span>
<span class="sd">            A dictionary containing profiles to register as part of the model. Keys in the dictionary should correspond</span>
<span class="sd">            to the name of the physical quantity being described by the corresponding profile.</span>

<span class="sd">            The profiles provided are saved to the skeleton at ``path``. They are then accessible via the :py:attr:`profiles` attribute</span>
<span class="sd">            of the created :py:class:`Model` instance.</span>

<span class="sd">            .. tip::</span>

<span class="sd">                At its core, the :py:class:`Model` has no expectations on the profiles that are provided. They are all</span>
<span class="sd">                registered directly using the name / value provided in ``profiles``. In many subclasses, the accessible</span>
<span class="sd">                solution pathways may be dictated (partially or in whole) by what profiles the user registered upon</span>
<span class="sd">                initializing the class. Generally, these are accompanied with &quot;generator methods&quot;, which handle the naming</span>
<span class="sd">                and registration for the user.</span>

<span class="sd">        coordinate_system : :py:class:`~pisces.geometry.base.CoordinateSystem`, optional</span>
<span class="sd">            The coordinate system that defines the dimensionality and axes of the grid. If a coordinate system is not</span>
<span class="sd">            provided, then the default coordinate system (:py:attr:`DEFAULT_COORDINATE_SYSTEM`) will be used. If there is</span>
<span class="sd">            no default coordinate system for this class, then an error is raised.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :py:class:`~pisces.io.hdf5.HDF5_File_Handle`</span>
<span class="sd">            A handle to the newly created HDF5 file representing the model.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any of the input parameters fail validation, or the file path exists</span>
<span class="sd">            without ``overwrite=True``.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The method validates the provided `coordinate_system` against the model&#39;s</span>
<span class="sd">          allowed systems.</span>
<span class="sd">        - The `bbox` and `grid_shape` parameters define the spatial extent and resolution</span>
<span class="sd">          of the model grid.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        pisces.io.hdf5.HDF5_File_Handle : HDF5 file interface.</span>
<span class="sd">        pisces.models.grids.base.ModelGridManager : Manages grid structure and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[BLDR] Building model skeleton at path: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="c1"># VALIDATE path. Convert to a path object and manage overwriting.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; already exists. Use `overwrite=True` to overwrite.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># VALIDATE coordinate system</span>
        <span class="k">if</span> <span class="n">coordinate_system</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_COORDINATE_SYSTEM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coordinate_system</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_COORDINATE_SYSTEM</span><span class="p">(</span>
                    <span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_COORDINATE_SYSTEM_PARAMS</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Coordinate system must be provided to build the model skeleton.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># CREATE the file reference</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">HDF5_File_Handle</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">switch_mode</span><span class="p">(</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[BLDR] HDF5 file created successfully.&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize the grid manager skeleton</span>
        <span class="n">ModelGridManager</span><span class="o">.</span><span class="n">build_skeleton</span><span class="p">(</span>
            <span class="n">handle</span><span class="o">=</span><span class="n">handle</span><span class="p">,</span>
            <span class="n">coordinate_system</span><span class="o">=</span><span class="n">coordinate_system</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span>
            <span class="n">grid_shape</span><span class="o">=</span><span class="n">grid_shape</span><span class="p">,</span>
            <span class="n">chunk_shape</span><span class="o">=</span><span class="n">chunk_shape</span><span class="p">,</span>
            <span class="n">length_unit</span><span class="o">=</span><span class="n">length_unit</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[BLDR] Grid manager skeleton built successfully.&quot;</span><span class="p">)</span>

        <span class="n">handle</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="s2">&quot;PROFILES&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">profiles</span><span class="p">:</span>
            <span class="n">profile_registry</span> <span class="o">=</span> <span class="n">HDF5ProfileRegistry</span><span class="p">(</span><span class="n">handle</span><span class="p">[</span><span class="s2">&quot;PROFILES&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">profiles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">profile_registry</span><span class="o">.</span><span class="n">add_profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Profile &#39;</span><span class="si">%s</span><span class="s2">&#39; added successfully.&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[BLDR] Model skeleton created successfully at &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handle</span></div>


    <span class="c1"># @@ VALIDATORS @@ #</span>
    <span class="c1"># These methods are for validating various types.</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_cls_validate_coordinate_system</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cs</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the coordinate system of the model.</span>

<span class="sd">        Ensures the coordinate system matches allowed systems.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cs: CoordinateSystem</span>
<span class="sd">            The coordinate system to validate against.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the coordinate system is not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">GRID_MANAGER_TYPE</span><span class="o">.</span><span class="n">ALLOWED_COORDINATE_SYSTEMS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">cs</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_MANAGER_TYPE</span><span class="o">.</span><span class="n">ALLOWED_COORDINATE_SYSTEMS</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid coordinate system for Model subclass </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cs</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">This error likely indicates&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; that you are trying to initialize a structure with a coordinate system which is not compatible&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; with the model.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the coordinate system of the model.</span>

<span class="sd">        Ensures the coordinate system matches allowed systems.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the coordinate system is not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_validate_coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_system</span><span class="p">)</span>

    <span class="c1"># @@ DUNDER METHODS @@ #</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: path=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pathway</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_model</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">pathway</span><span class="o">=</span><span class="n">pathway</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ModelField&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> has no field named </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">__</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Model objects do not permit direct setting using __setitem__.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Model&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">path</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> has no field named </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span>

    <span class="c1"># @@ PROPERTIES @@ #</span>
    <span class="c1"># These properties should generally not be altered as they</span>
    <span class="c1"># reference private attributes of the class; however, additional</span>
    <span class="c1"># properties may need to be implemented depending on the use case.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The file path associated with this :py:class:`Model` instance&#39;s location on disk.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HDF5_File_Handle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the HDF5 file handle associated with the model.</span>

<span class="sd">        This handle provides a direct interface to the underlying HDF5 file, enabling</span>
<span class="sd">        interaction with raw data stored in the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :py:class:`~pisces.io.hdf5.HDF5_File_Handle`</span>
<span class="sd">            The HDF5 file handle for the model.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The handle is used internally for reading and writing data to the file.</span>
<span class="sd">        Direct interaction with the handle should be avoided unless necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">handle</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grid_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelGridManager</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The grid manager for the model.</span>

<span class="sd">        The grid manager (:py:class:`~pisces.models.grids.base.ModelGridManager`) is responsible for handling all grid-related operations,</span>
<span class="sd">        including spatial coordinates, field storage, and grid configuration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :py:class:`pisces.models.grids.base.ModelGridManager`</span>
<span class="sd">            An instance of the grid manager for this model.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The grid manager interacts directly with the HDF5 file and handles grid</span>
<span class="sd">        initialization, chunking, and spatial alignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span>

    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">FIELDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ModelFieldContainer&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the fields stored in the model&#39;s :py:attr:`grid_manager`.</span>

<span class="sd">        Fields are data arrays stored within the grid manager, typically representing</span>
<span class="sd">        physical quantities such as density, pressure, or temperature.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :py:class:`~pisces.models.grids.base.ModelFieldContainer`</span>
<span class="sd">            A container holding all fields managed</span>
<span class="sd">            by the grid manager.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The fields interface provides access to stored data arrays and allows retrieval</span>
<span class="sd">        or modification of grid-based quantities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">FIELDS</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CoordinateSystem</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the coordinate system used by the model.</span>

<span class="sd">        The coordinate system defines the spatial framework (e.g., spherical,</span>
<span class="sd">        cylindrical, or Cartesian) over which the grid and profiles are defined.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :py:class:`~pisces.geometry.base.CoordinateSystem`</span>
<span class="sd">            The coordinate system object associated with the model.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The coordinate system must match one of the ``ALLOWED_COORDINATE_SYSTEMS``</span>
<span class="sd">        specified by the model. This ensures consistency between grid operations</span>
<span class="sd">        and the physics of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">coordinate_system</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geometry_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeometryHandler</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the geometry handler for the model.</span>

<span class="sd">        The geometry handler manages operations that depend on the model&#39;s spatial</span>
<span class="sd">        framework, such as gradients, integrals, and field transformations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :py:class:`~pisces.geometry.handler.GeometryHandler`</span>
<span class="sd">            An instance of the `GeometryHandler` class initialized with the model&#39;s</span>
<span class="sd">            coordinate system and free axes.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - If the geometry handler has not been initialized, it is created dynamically</span>
<span class="sd">          using the model&#39;s coordinate system and `INIT_FREE_AXES`.</span>
<span class="sd">        - The free axes are used to determine the directions along which operations</span>
<span class="sd">          such as gradients and integrals are performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT_FREE_AXES</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">free_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT_FREE_AXES</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">AXES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_handler</span> <span class="o">=</span> <span class="n">GeometryHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_system</span><span class="p">,</span> <span class="n">free_axes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_handler</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HDF5ProfileRegistry</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the profiles stored in the model.</span>

<span class="sd">        Profiles are functional or tabulated representations of physical quantities</span>
<span class="sd">        (e.g., density, temperature) that can be evaluated over the grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :py:class:`~pisces.profiles.collections.HDF5ProfileRegistry`</span>
<span class="sd">            A registry containing all profiles associated with the model.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Profiles are typically used to initialize or compute grid fields. They can</span>
<span class="sd">        be stored in the HDF5 file and retrieved for further computations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiles</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_solved</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Boolean flag indicating whether the model is solved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">is_solved</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_pathway</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The default pathway associated with this model instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">default</span>

    <span class="nd">@default_pathway</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">default_pathway</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathway</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pathway</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">list_pathways</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">pathway</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pathway </span><span class="si">{</span><span class="n">pathway</span><span class="si">}</span><span class="s2"> is not recognized for models of class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Recognized pathways are </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">list_pathways</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># @@ UTILITY FUNCTIONS @@ #</span>
    <span class="c1"># These utility functions are used throughout the model generation process for various things</span>
    <span class="c1"># and are not sufficiently general to be worth implementing elsewhere.</span>
    <span class="k">def</span> <span class="nf">_assign_default_units_and_add_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">field_data</span><span class="p">:</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">,</span>
        <span class="n">create_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigns the appropriate units to a field and optionally adds it to the model&#39;s field container.</span>

<span class="sd">        This utility method ensures that a given field has the correct physical units before being</span>
<span class="sd">        integrated into the model&#39;s field container. It facilitates consistency and correctness</span>
<span class="sd">        in the model&#39;s physical quantities by enforcing unit assignments and managing field</span>
<span class="sd">        registrations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field_name : str</span>
<span class="sd">            The name of the field to process. This name is used both for logging purposes and</span>
<span class="sd">            when adding the field to the model&#39;s field container.</span>

<span class="sd">        field_data : unyt.unyt_array</span>
<span class="sd">            The raw data of the field as a `unyt.unyt_array`. This array contains both the</span>
<span class="sd">            numerical values and their associated units.</span>

<span class="sd">        create_field : bool, optional</span>
<span class="sd">            A flag indicating whether the processed field should be added to the model&#39;s</span>
<span class="sd">            field container (`self.FIELDS`). If `True`, the field is registered; if `False`,</span>
<span class="sd">            the field is only processed for unit consistency.</span>

<span class="sd">        axes : Optional[List[str]], default=None</span>
<span class="sd">            A list of axis names that the field depends on (e.g., `[&#39;r&#39;]` for radial dependence).</span>
<span class="sd">            If not provided, it defaults to `[&#39;r&#39;]`, assuming radial dependence.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unyt.unyt_array</span>
<span class="sd">            The processed field data with the correct units assigned.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the specified `field_name` does not have a corresponding default unit defined</span>
<span class="sd">            within the model. This ensures that all fields have predefined unit expectations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the input axes. By default, we&#39;ll just adopt the standard initial axes and / or</span>
        <span class="c1"># rely on the full axes set from the coordinate system.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INIT_FREE_AXES</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT_FREE_AXES</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">AXES</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Attempt to look up the default units from the configuration file. If the configuration</span>
        <span class="c1"># doesn&#39;t exist, this will cause an error to be raised.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_units</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No default units defined for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># Manage the field creation process. If we are adding the field, it can just be passed off</span>
        <span class="c1"># to the field manager as normal. The logging statement is standardized across all</span>
        <span class="c1"># models inheriting this method.</span>
        <span class="k">if</span> <span class="n">create_field</span><span class="p">:</span>
            <span class="c1"># Add the field to the model&#39;s field container</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="n">field_name</span><span class="p">,</span>
                <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">units</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">field_data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;[EXEC] Added field &#39;</span><span class="si">%s</span><span class="s2">&#39; (units=</span><span class="si">%s</span><span class="s2">, ndim=</span><span class="si">%s</span><span class="s2">).&quot;</span><span class="p">,</span>
                <span class="n">field_name</span><span class="p">,</span>
                <span class="n">units</span><span class="p">,</span>
                <span class="n">field_data</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Return the field so that it can be accessed if this was just a unit validation method.</span>
        <span class="k">return</span> <span class="n">field_data</span>

    <span class="k">def</span> <span class="nf">_validate_field_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that all required fields exist for the equation of state computation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot compute </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">. Missing fields: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_coerce_extent_for_plots</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic utility function to coerce extent args passed to plotting</span>
<span class="sd">        routines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        extent: Any</span>
<span class="sd">        The extent to coerce.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># Extent provided as (array, unit) tuple.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extent parameter: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">):</span>
            <span class="c1"># Attempt to convert to unyt_array using the built-in length units.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">length_unit</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid extent parameter: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># naturally an unyt array.</span>
            <span class="k">pass</span>

        <span class="n">extent_scaled</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">length_unit</span><span class="p">)</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">extent</span>

        <span class="k">return</span> <span class="n">extent</span><span class="p">,</span> <span class="n">extent_scaled</span>

    <span class="c1"># @@ CORE METHODS @@ #</span>
    <span class="c1"># These are the standard methods of the class. They</span>
    <span class="c1"># should generally not need to be changed. Any subclass-specific</span>
    <span class="c1"># capabilities are reserved for implementation in the</span>
    <span class="c1"># relevant subclass.</span>
<div class="viewcode-block" id="Model.get_pathway">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.get_pathway.html#pisces.models.base.Model.get_pathway">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_pathway</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pathway</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch information about a particular solution pathway in this :py:class:`Model` class.</span>

<span class="sd">        Each pathway in the model has 2 components:</span>

<span class="sd">        1. **Processes** (``dict``): The list of steps in the pathway. Each entry in the processes dictionary</span>
<span class="sd">           is an ``int`` corresponding to the order of the process in the pathway. Each value in the processes</span>
<span class="sd">           dictionary is another dictionary with the following information:</span>

<span class="sd">           - ``name`` (``str``): The name of the method (of :py:class:`Model` / subclass thereof) which executes this</span>
<span class="sd">             step in the pathway.</span>
<span class="sd">           - ``args`` (``list[Any]``): Additional arguments (aside from the :py:class:`Model` instance) which are</span>
<span class="sd">             passed to this step in the pathway.</span>
<span class="sd">           - ``kwargs`` (``dict[Any, Any]``): Additional keyword arguments which are passed to this step in the pathway.</span>
<span class="sd">           - ``desc`` (``str``): The short description of the step process.</span>

<span class="sd">        2. **Checkers** (``list[str]``): The list of checker methods (of :py:class:`Model` / subclass thereof) which are</span>
<span class="sd">           called to validate this pathway.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pathway: str</span>
<span class="sd">            The name of the pathway to fetch.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The processes dictionary.</span>
<span class="sd">        list</span>
<span class="sd">            The checker methods list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s2">&quot;processes&quot;</span><span class="p">],</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">[</span><span class="n">pathway</span><span class="p">][</span><span class="s2">&quot;checkers&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The pathway &#39;</span><span class="si">{</span><span class="n">pathway</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.get_pathway_step">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.get_pathway_step.html#pisces.models.base.Model.get_pathway_step">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_pathway_step</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pathway</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch information about a particular step in a solution pathway of this :py:class:`Model` class.</span>

<span class="sd">        Each step in the pathway has the following components:</span>

<span class="sd">        - ``name`` (``str``): The name of the method (of :py:class:`Model` / subclass thereof) which executes this</span>
<span class="sd">          step in the pathway.</span>
<span class="sd">        - ``args`` (``list[Any]``): Additional arguments (aside from the :py:class:`Model` instance) which are</span>
<span class="sd">          passed to this step in the pathway.</span>
<span class="sd">        - ``kwargs`` (``dict[Any, Any]``): Additional keyword arguments which are passed to this step in the pathway.</span>
<span class="sd">        - ``desc`` (``str``): The short description of the step process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pathway: str</span>
<span class="sd">            The name of the pathway to fetch.</span>
<span class="sd">        step: int</span>
<span class="sd">            The index of the step in the pathway.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_pathway</span><span class="p">(</span><span class="n">pathway</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">step</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The pathway &#39;</span><span class="si">{</span><span class="n">pathway</span><span class="si">}</span><span class="s2">&#39; does not have the step &#39;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="Model.get_pathway_length">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.get_pathway_length.html#pisces.models.base.Model.get_pathway_length">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_pathway_length</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pathway</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the length of a specific pathway in the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pathway: str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processes</span><span class="p">,</span> <span class="n">checkers</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_pathway</span><span class="p">(</span><span class="n">pathway</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.list_pathways">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.list_pathways.html#pisces.models.base.Model.list_pathways">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">list_pathways</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of the pathway names present in this :py:class:`Model` class.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            A list of pathways names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="Model.pathway_summary">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.pathway_summary.html#pisces.models.base.Model.pathway_summary">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pathway_summary</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pathway_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a tabulated summary of the specified solver pathway for this model class.</span>

<span class="sd">        This class method retrieves details about a given pathway from the class-level</span>
<span class="sd">        :py:attr:`_PATHWAYS` dictionary, builds a table of process steps (including step</span>
<span class="sd">        numbers, arguments, keyword arguments, and short descriptions), and prints that table</span>
<span class="sd">        alongside a list of checkers for quick reference.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pathway_name : str</span>
<span class="sd">            The name of the solver pathway to summarize. Must match a key in</span>
<span class="sd">            :py:attr:`_PATHWAYS`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ImportError</span>
<span class="sd">            If the ``tabulate`` package is not installed, which is required to format the table.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the specified ``pathway_name`` does not exist in :py:attr:`_PATHWAYS`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            # Suppose your Model class or subclass has a pathway named &quot;cooling_flow&quot;.</span>
<span class="sd">            # You can display its summary (steps, arguments, checkers) like so:</span>

<span class="sd">            MyModel.pathway_summary(&quot;cooling_flow&quot;)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The process steps are sorted by their step number in ascending order.</span>
<span class="sd">        - Arguments and keyword arguments (``args`` / ``kwargs``) are displayed in</span>
<span class="sd">          multi-line format for readability.</span>
<span class="sd">        - If no checkers exist for this pathway, &quot;None&quot; is displayed.</span>
<span class="sd">        - The first line of each process method&#39;s docstring is shown in the &quot;Description&quot;</span>
<span class="sd">          column, if available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;tabulate&#39; package is required to display a pathway summary. &quot;</span>
                <span class="s2">&quot;Please install it via &#39;pip install tabulate&#39;.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="c1"># Ensure the pathway exists in this class&#39;s _PATHWAYS dictionary.</span>
        <span class="k">if</span> <span class="n">pathway_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pathway &#39;</span><span class="si">{</span><span class="n">pathway_name</span><span class="si">}</span><span class="s2">&#39; does not exist. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available pathways: </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Retrieve relevant data about the pathway.</span>
        <span class="n">pathway_data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PATHWAYS</span><span class="p">[</span><span class="n">pathway_name</span><span class="p">]</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="n">pathway_data</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]</span>
        <span class="n">checkers</span> <span class="o">=</span> <span class="n">pathway_data</span><span class="p">[</span><span class="s2">&quot;checkers&quot;</span><span class="p">]</span>

        <span class="c1"># Prepare a table of processes, sorted by step number.</span>
        <span class="n">process_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step_number</span><span class="p">,</span> <span class="n">process_info</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">processes</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># Format arguments in a multi-line string.</span>
            <span class="n">arg_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">arg_item</span> <span class="ow">in</span> <span class="n">process_info</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># For lists, we show them in a bracketed, multi-line fashion.</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">subitem</span><span class="p">)</span> <span class="k">for</span> <span class="n">subitem</span> <span class="ow">in</span> <span class="n">arg_item</span><span class="p">)</span>
                    <span class="n">arg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="se">\n</span><span class="si">{</span><span class="n">contents</span><span class="si">}</span><span class="se">\n</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg_item</span><span class="p">))</span>
            <span class="n">arg_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_lines</span><span class="p">)</span>

            <span class="c1"># Format keyword arguments similarly (multi-line).</span>
            <span class="n">kwarg_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">process_info</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">kwarg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">kwarg_string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwarg_lines</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span> <span class="k">if</span> <span class="n">kwarg_lines</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Use the short docstring snippet if available; fallback if empty or None.</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">process_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="s2">&quot;No Description&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;No Description&quot;</span>

            <span class="n">process_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">step_number</span><span class="p">,</span>
                    <span class="n">process_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">arg_string</span><span class="p">,</span>
                    <span class="n">kwarg_string</span><span class="p">,</span>
                    <span class="n">desc</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Column headers for the table of processes.</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Step&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Process Name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Arguments&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Keyword Arguments&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Description&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">process_table_str</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">process_table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">)</span>

        <span class="c1"># Format the checker list (if any).</span>
        <span class="k">if</span> <span class="n">checkers</span><span class="p">:</span>
            <span class="n">checkers_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">checker</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">checker</span> <span class="ow">in</span> <span class="n">checkers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checkers_str</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

        <span class="c1"># Print the assembled summary.</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">====================== Pathway Summary: &#39;</span><span class="si">{</span><span class="n">pathway_name</span><span class="si">}</span><span class="s2">&#39; ======================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Steps:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">process_table_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Checkers:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">checkers_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===============================================================================&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Model.get_default_units">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.get_default_units.html#pisces.models.base.Model.get_default_units">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_default_units</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unyt</span><span class="o">.</span><span class="n">Unit</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the default units for a specified field.</span>

<span class="sd">        This method looks up the default units for a given field name from the</span>
<span class="sd">        :py:attr:`~pisces.models.base.Model.config` configuration</span>
<span class="sd">        dictionary, which stores model-specific parameters including field units.</span>
<span class="sd">        If the field name is not found in the configuration, an exception is raised.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field_name : str</span>
<span class="sd">            The name of the field for which the default units are to be retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unyt.Unit</span>
<span class="sd">            The corresponding units for the specified field as a `unyt.Unit` object.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the specified field name is not found in the :py:attr:`~pisces.models.base.Model.config`</span>
<span class="sd">            dictionary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fetch the unit data from the field entry in the</span>
        <span class="c1"># parameters object.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_unit_str</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fields.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">.units&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_unit_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get default units for field `</span><span class="si">%s</span><span class="s2">` because it is not a known field.&quot;</span>
                <span class="o">%</span> <span class="n">field_name</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to access the configuration utility for model class </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Attempt to return the unit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unyt</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">_unit_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to convert string unit </span><span class="si">{</span><span class="n">_unit_str</span><span class="si">}</span><span class="s2"> to unyt.Unit object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Model.solve_model">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.solve_model.html#pisces.models.base.Model.solve_model">[docs]</a>
    <span class="k">def</span> <span class="nf">solve_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pathway</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve this model using one of the solution pathways associated with it.</span>

<span class="sd">        Every physical model in Pisces implements one (or many) solution &quot;pathways&quot; which take</span>
<span class="sd">        the model from an &quot;empty&quot; state to a completed state. This process is called &quot;solving&quot; the model</span>
<span class="sd">        and is achieved by calling the :py:meth:`solve_model` method on the model in question.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If ``True``, then the :py:class:`Model` will be solved even if it has already been solved.</span>
<span class="sd">            This will overwrite any data that was written during a previous solution if necessary.</span>

<span class="sd">            .. warning::</span>

<span class="sd">                This can be disastrous if done unintentionally! Make sure you do not set ``overwrite=True`` lightly.</span>
<span class="sd">                Solving models can be expensive and time-consuming. Loosing all your data to have to solve the model again</span>
<span class="sd">                is both inefficient and potentially frustrating.</span>

<span class="sd">        pathway : Optional[str], optional</span>

<span class="sd">            The solution pathway to execute. If ``pathway`` is not specified, then the solver will attempt to use</span>
<span class="sd">            the default pathway (:py:attr:`default_pathway`). If no default pathway exists, an error is raised insisting</span>
<span class="sd">            that a pathway choice be provided.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the solver is already solved and ``overwrite`` is False.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the pathway is not valid or cannot be executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate that the solver exists for this class and set the pathway / default pathway.</span>
        <span class="c1"># produce some logging information for the user.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_solver&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;The solver is not initialized. This error shouldn&#39;t be possible...&quot;</span>
            <span class="p">)</span>

        <span class="n">pathway</span> <span class="o">=</span> <span class="n">pathway</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_pathway</span>
        <span class="k">if</span> <span class="n">pathway</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No `pathway` was provided and </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> has no default pathway set.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please specify a pathway or a default pathway to solve the model.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Produce the basic logging information for the user.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EXEC] Solving model </span><span class="si">%s</span><span class="s2">. &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EXEC] </span><span class="se">\t</span><span class="s2">PATHWAY = </span><span class="si">%s</span><span class="s2">. &quot;</span><span class="p">,</span> <span class="n">pathway</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EXEC] </span><span class="se">\t</span><span class="s2">NUM_STEPS = </span><span class="si">%s</span><span class="s2">. &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pathway_length</span><span class="p">(</span><span class="n">pathway</span><span class="p">))</span>

        <span class="c1"># Pass the runtime off to the solver to continue the solution procedure.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">(</span><span class="n">pathway</span><span class="o">=</span><span class="n">pathway</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;[EXEC] Runtime error during execution of pathway &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">pathway</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;[EXEC] Error during execution of pathway &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">pathway</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;[EXEC] Successfully executed pathway &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
                <span class="n">pathway</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Model.summary">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.summary.html#pisces.models.base.Model.summary">[docs]</a>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a comprehensive console summary of the current model state.</span>

<span class="sd">        This method invokes the ``tabulate`` library (if available) to present various</span>
<span class="sd">        aspects of the model in a tabular format, such as:</span>

<span class="sd">        1. **General Information**:</span>
<span class="sd">           - The model&#39;s file ``path`` (if any).</span>
<span class="sd">           - Whether the model is already solved.</span>
<span class="sd">           - The default pathway (if one is set).</span>

<span class="sd">        2. **Available Fields**:</span>
<span class="sd">           A table enumerating all fields in the model, retrieved from</span>
<span class="sd">           :py:meth:`self.FIELDS.get_field_summary`, showing information</span>
<span class="sd">           such as field names, units, shapes, and axes.</span>

<span class="sd">        3. **Available Profiles**:</span>
<span class="sd">           A summary of the model&#39;s profiles, as returned by</span>
<span class="sd">           :py:meth:`self.profiles.get_profile_summary`, typically including</span>
<span class="sd">           profile names and relevant metadata.</span>

<span class="sd">        4. **Grid Information**:</span>
<span class="sd">           Details about the grid structure (bounding box, chunk shape, scale,</span>
<span class="sd">           etc.), via :py:meth:`self.grid_manager.get_grid_summary`.</span>

<span class="sd">        The summary is printed directly to stdout. Use this for a quick</span>
<span class="sd">        diagnostic or overview of the model&#39;s configuration and data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the ``tabulate`` library cannot be imported (i.e., it is not installed).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            my_model = SomeDerivedModel(...)</span>
<span class="sd">            # ... possibly load or compute fields ...</span>
<span class="sd">            my_model.summary()</span>

<span class="sd">            # Outputs a multi-section summary of the model&#39;s current state, including</span>
<span class="sd">            # any fields, profiles, and grid setup.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - If you wish to display more granular details about a specific solver</span>
<span class="sd">          pathway, see :py:meth:`Model.pathway_summary` (class-level) or</span>
<span class="sd">          :py:meth:`pathway_summary` (instance-level method, if defined).</span>
<span class="sd">        - The layout of the printed summary may be subject to terminal width</span>
<span class="sd">          or formatting constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate that we can get the tabulate package correctly. Otherwise we need</span>
        <span class="c1"># to raise an error.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot import tabulate package.&quot;</span><span class="p">)</span>

        <span class="c1"># Build the tables using subfunctions and custom implementations.</span>
        <span class="n">ptable</span><span class="p">,</span> <span class="n">gtable</span><span class="p">,</span> <span class="n">ftable</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">get_profile_summary</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">get_grid_summary</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="o">.</span><span class="n">get_field_summary</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="n">model_table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;Path&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;Solved&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_solved</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;Default Pathway&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_pathway</span><span class="p">)],</span>
            <span class="p">],</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Attribute&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span>
            <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Summary Tables</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===================== Model Summary =====================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;General Information:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model_table</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Available Fields:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ftable</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Available Profiles:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ptable</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Grid Information:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gtable</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=========================================================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Model.plot_slice">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.plot_slice.html#pisces.models.base.Model.plot_slice">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_slice</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">extent</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">view_axis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
        <span class="n">figure</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Figure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Axes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
        <span class="n">view_axis_position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pisces.utilities.plotting</span> <span class="kn">import</span> <span class="n">construct_subplot</span>

        <span class="c1"># Setup the subplot / figure to ensure that they</span>
        <span class="c1"># are present</span>
        <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">construct_subplot</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>

        <span class="c1"># Validate the extent attribute. May be an unyt_array or Tuple(list, str) or simply</span>
        <span class="c1"># a basic list-like object. All cases need to be handled naturally.</span>
        <span class="n">extent_image</span><span class="p">,</span> <span class="n">extent_backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_extent_for_plots</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>

        <span class="c1"># Construct the image array from inputs.</span>
        <span class="n">image_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">generate_slice_image_array</span><span class="p">(</span>
            <span class="n">field_name</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">view_axis</span><span class="p">),</span>
            <span class="n">extent_backend</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
            <span class="n">view_axis_position</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check for non-plotting calls. This allows users more control over</span>
        <span class="c1"># plot routines by simply getting the image out on its own.</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;noplot&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">image_array</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span>

        <span class="c1"># Add the image to the plot. Utilize the normalization passed via kwargs</span>
        <span class="c1"># if necessary and the colormap.</span>
        <span class="n">imshow_object</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent_image</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Managing axes labels, ticks, etc.</span>
        <span class="n">_axes_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ax</span> <span class="o">!=</span> <span class="n">view_axis</span><span class="p">]</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;$</span><span class="si">%s</span><span class="s2">$ / $\left[</span><span class="si">%s</span><span class="s2">\right]$&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">_axes_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent_image</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">latex_repr</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;$</span><span class="si">%s</span><span class="s2">$ / $\left[</span><span class="si">%s</span><span class="s2">\right]$&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">_axes_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent_image</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">latex_repr</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">field_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fields.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">.label&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_label</span> <span class="o">=</span> <span class="n">field_name</span>

        <span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
            <span class="n">imshow_object</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> / $\left[</span><span class="si">%s</span><span class="s2">\right]$&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">field_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">latex_repr</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">image_array</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span></div>


    <span class="c1"># noinspection PyIncorrectDocstring</span>
<div class="viewcode-block" id="Model.add_field_from_function">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.add_field_from_function.html#pisces.models.base.Model.add_field_from_function">[docs]</a>
    <span class="k">def</span> <span class="nf">add_field_from_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a :py:class:`~pisces.models.grids.base.ModelField` in this model&#39;s</span>
<span class="sd">        :py:class:`~pisces.models.grids.base.ModelGridManager` by evaluating the provided function.</span>

<span class="sd">        This method takes a function (``function``) and evaluates it at the relevant grid points to generate</span>
<span class="sd">        a new field with name ``field_name``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        function : Callable</span>
<span class="sd">            A function which takes (as input) ``N`` arguments ``(x_1,...,x_N)`` corresponding to the coordinate</span>
<span class="sd">            values of the ``N`` axes specified by the ``axes`` argument. If ``axes`` is not specified, then ``N=NDIM``, where</span>
<span class="sd">            ``NDIM`` is the number of dimensions in the coordinate system.</span>
<span class="sd">        field_name : str</span>
<span class="sd">            The name to give to the newly generated field.</span>

<span class="sd">            .. note::</span>

<span class="sd">                The ``field_name`` will be the location in the HDF5 file as well (``FIELDS/field_name``).</span>

<span class="sd">        axes : Optional[List[str]], optional</span>
<span class="sd">            The coordinate axes along which the function is to be evaluated. If ``axes`` is not provided, then</span>
<span class="sd">            it is assumed that the function operates on all the coordinates of the coordinate system.</span>

<span class="sd">            .. hint::</span>

<span class="sd">                Ensure that ``axes`` is self-consistent with the call signature of the ``function`` parameter.</span>

<span class="sd">        chunking : bool, optional</span>
<span class="sd">            If `True`, evaluate the function in chunks. Default is `False`.</span>

<span class="sd">            .. tip::</span>

<span class="sd">                This is generally not necessary unless you cannot load the entire base grid into memory at once. This</span>
<span class="sd">                is particularly common if the function is operating in 3 or more dimensions, in which case even moderately</span>
<span class="sd">                resolved grids may take up significant memory.</span>

<span class="sd">        units : Optional[str], optional</span>
<span class="sd">            The units to give to the field. If ``units`` is not provided, then it is assumed that the field is</span>
<span class="sd">            dimensionless.</span>
<span class="sd">        dtype : str, optional</span>
<span class="sd">            The data type of the field. Default is &quot;f8&quot;.</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If `True`, overwrite an existing field with the same name. Default is `False`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the function, axes, or other parameters are invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__logging__</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;logging&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Pass to the grid manager to add the field.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">add_field_from_function</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># log the output.</span>
        <span class="k">if</span> <span class="n">__logging__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[SLVR] Field &#39;</span><span class="si">%s</span><span class="s2">&#39; added from function.&quot;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></div>


    <span class="c1"># noinspection PyIncorrectDocstring</span>
<div class="viewcode-block" id="Model.add_field_from_profile">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.add_field_from_profile.html#pisces.models.base.Model.add_field_from_profile">[docs]</a>
    <span class="k">def</span> <span class="nf">add_field_from_profile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Profile</span><span class="p">],</span> <span class="n">field_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a :py:class:`~pisces.models.grids.base.ModelField` in this model&#39;s</span>
<span class="sd">        :py:class:`~pisces.models.grids.base.ModelGridManager` by evaluating a profile.</span>

<span class="sd">        This method effectively wraps the :py:meth:`ModelGridManager.add_field_from_function` but utilizes the axes</span>
<span class="sd">        information from the profile to reduce the number of necessary inputs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profile : str or :py:class:`~pisces.profiles.base.Profile`</span>
<span class="sd">            Any valid :py:class:`~pisces.profiles.base.Profile` instance or a string referencing a profile in the</span>
<span class="sd">            model&#39;s registry (:py:attr:`profiles`).</span>

<span class="sd">            .. hint::</span>

<span class="sd">                To be a valid :py:class:`~pisces.profiles.base.Profile` instance, the profile must have the same</span>
<span class="sd">                axes as :py:attr:`coordinate_system` or have axes which are a subset of them.</span>

<span class="sd">        field_name : str, optional</span>
<span class="sd">            The name to give to the newly generated field. If ``profile`` is a string and this is not filled, then</span>
<span class="sd">            the new field will have the same name as ``profile``. Otherwise, ``field_name`` is required.</span>

<span class="sd">            .. note::</span>

<span class="sd">                The ``field_name`` will be the location in the HDF5 file as well (``FIELDS/field_name``).</span>

<span class="sd">        chunking : bool, optional</span>
<span class="sd">            If `True`, evaluate the function in chunks. Default is `False`.</span>

<span class="sd">            .. tip::</span>

<span class="sd">                This is generally not necessary unless you cannot load the entire base grid into memory at once. This</span>
<span class="sd">                is particularly common if the function is operating in 3 or more dimensions, in which case even moderately</span>
<span class="sd">                resolved grids may take up significant memory.</span>

<span class="sd">        units : Optional[str], optional</span>
<span class="sd">            The units to give to the field. If ``units`` is not provided, then it is assumed that the field is</span>
<span class="sd">            dimensionless.</span>
<span class="sd">        dtype : str, optional</span>
<span class="sd">            The data type of the field. Default is &quot;f8&quot;.</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If `True`, overwrite an existing field with the same name. Default is `False`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the function, axes, or other parameters are invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__logging__</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;logging&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Setup the profile. If we got an actual profile, we need to check for the name</span>
        <span class="c1"># in the kwargs. Otherwise we need to look up the profile using the string we have.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">Profile</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`profile` argument was a Profile class, `profile_name` is a required kwarg.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">profile</span>

                <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">profile</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profile `</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">` not found.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`profile` must be either a string or a Profile class.&quot;</span><span class="p">)</span>

        <span class="c1"># Now pass along to the grid manager to actually add the field.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">add_field_from_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Produce the output log.</span>
        <span class="k">if</span> <span class="n">__logging__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;[SLVR] Field &#39;</span><span class="si">%s</span><span class="s2">&#39; added from internal profile.&quot;</span><span class="p">,</span> <span class="n">field_name</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Model.convert_profile_to_field">
<a class="viewcode-back" href="../../../_as_gen/pisces.models.base.Model.convert_profile_to_field.html#pisces.models.base.Model.convert_profile_to_field">[docs]</a>
    <span class="k">def</span> <span class="nf">convert_profile_to_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">profile_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">field_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a profile to a model field.</span>

<span class="sd">        Ensures that a specified profile in :py:attr:`profiles` is converted into a field within the model.</span>
<span class="sd">        If ``field_name`` is not provided, it defaults to ``profile_name``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profile_name : str</span>
<span class="sd">            The name of the profile to convert to a field. Must exist within :py:attr:`profiles`.</span>

<span class="sd">        field_name : str, optional</span>
<span class="sd">            The desired name for the resulting field. Defaults to ``profile_name`` if not provided.</span>

<span class="sd">        overwrite : bool, default=False</span>
<span class="sd">            If ``True``, existing field with the same name will be overwritten. If ``False`` and the</span>
<span class="sd">            field already exists, a ``ValueError`` is raised.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``profile_name`` does not exist in :py:attr:`profiles` or if ``overwrite`` is ``False`` and</span>
<span class="sd">            the field already exists.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Look up the provided profile and ensure that it exists as expected.</span>
        <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The profile `</span><span class="si">{</span><span class="n">profile_name</span><span class="si">}</span><span class="s2">` does not appear to be present in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="n">profile_name</span><span class="p">]</span>

        <span class="c1"># Validate the field name. If the field name is not provided, we assume it</span>
        <span class="c1"># matches the profile name.</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">profile_name</span>

        <span class="c1"># Look up the correct units for the field based on that profile.</span>
        <span class="n">_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_units</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

        <span class="c1"># Add the profile directly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_field_from_profile</span><span class="p">(</span>
            <span class="n">profile</span><span class="p">,</span>
            <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
            <span class="n">chunking</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">_units</span><span class="p">),</span>
            <span class="n">logging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;[EXEC] </span><span class="se">\t\t</span><span class="s2">Added field `</span><span class="si">%s</span><span class="s2">` (units=</span><span class="si">%s</span><span class="s2">) from profile.&quot;</span><span class="p">,</span>
            <span class="n">field_name</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">_units</span><span class="p">),</span>
        <span class="p">)</span></div>
</div>



<span class="k">class</span> <span class="nc">_RadialModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Private extended base class of the standard model class for models</span>
<span class="sd">    which have a default radial symmetry. Provides basic utility functions for</span>
<span class="sd">    descendant methods which inherit from this model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># @@ VALIDATION MARKERS @@ #</span>
    <span class="c1"># These validation markers are used by the Model to constrain the valid</span>
    <span class="c1"># parameters for the model. Subclasses can modify the validation markers</span>
    <span class="c1"># to constrain coordinate system compatibility.</span>
    <span class="c1">#</span>
    <span class="c1"># : _IS_ABC : marks whether the model should seek out pathways or not.</span>
    <span class="c1"># : _INHERITS_PATHWAYS: will allow subclasses to inherit the pathways of their parent class.</span>
    <span class="n">_IS_ABC</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_INHERITS_PATHWAYS</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @@ CLASS PARAMETERS @@ #</span>
    <span class="c1"># The class parameters define several &quot;standard&quot; behaviors for the class.</span>
    <span class="c1"># These can be altered in subclasses to produce specific behaviors.</span>
    <span class="n">DEFAULT_COORDINATE_SYSTEM</span> <span class="o">=</span> <span class="n">SphericalCoordinateSystem</span>
    <span class="n">INIT_FREE_AXES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span>

    <span class="c1"># @@ UTILITY FUNCTIONS @@ #</span>
    <span class="c1"># These utility functions are used throughout the model generation process for various things</span>
    <span class="c1"># and are not sufficiently general to be worth implementing elsewhere.</span>
    <span class="k">def</span> <span class="nf">get_radii</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the radial coordinates in the appropriate length units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">length_unit</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct_radial_spline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">radii</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a radial spline for the specified field.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field_name : str</span>
<span class="sd">            Name of the field to spline.</span>
<span class="sd">        radii : unyt.unyt_array, optional</span>
<span class="sd">            Radial coordinates for interpolation. Defaults to the model&#39;s radial coordinates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        InterpolatedUnivariateSpline</span>
<span class="sd">            Spline of the field over the radial grid.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the field does not exist or is not defined over the radial axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the input field name and fetch the necessary field data and</span>
        <span class="c1"># base units. Ensure that field exists and that it is actually a radial field.</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; does not exist in the model.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">AXES</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; is not defined over the radial axis.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Manage the radii construction as needed based on the input.</span>
        <span class="k">if</span> <span class="n">radii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radii</span><span class="p">()</span><span class="o">.</span><span class="n">d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span><span class="o">.</span><span class="n">d</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">radii</span>

        <span class="n">field_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">field_data</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">integrate_radial_density_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">density_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mass_field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mass_unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">unyt</span><span class="o">.</span><span class="n">Unit</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrate a radial density field to compute the enclosed mass profile.</span>

<span class="sd">        This method takes a specified radial density field (e.g., gas, stellar, dark matter density),</span>
<span class="sd">        integrates it over the radial grid, and computes the enclosed mass profile. The resulting mass</span>
<span class="sd">        profile is returned as a `unyt.unyt_array` with appropriate units. Optionally, the computed mass</span>
<span class="sd">        can be added to the model&#39;s field container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        density_field : str</span>
<span class="sd">            Name of the density field to integrate. Must be one of:</span>
<span class="sd">            [&#39;total_density&#39;, &#39;gas_density&#39;, &#39;stellar_density&#39;, &#39;dark_matter_density&#39;].</span>

<span class="sd">        mass_field : str, optional</span>
<span class="sd">            Name of the mass field to create. If not provided, it is retrieved from the model&#39;s</span>
<span class="sd">            configuration under `fields.{density_field}.mass_field`.</span>

<span class="sd">        mass_unit : str or unyt.Unit, optional</span>
<span class="sd">            Units for the mass field. If not provided, it is retrieved from the model&#39;s configuration</span>
<span class="sd">            under `fields.{density_field}.mass_unit`.</span>

<span class="sd">        create_field : bool, default=False</span>
<span class="sd">            If `True`, the integrated mass field will be added to the model&#39;s field container (`self.FIELDS`).</span>
<span class="sd">            Defaults to `False`.</span>

<span class="sd">        overwrite : bool, default=False</span>
<span class="sd">            If `True`, overwrite an existing mass field with the same name. If `False` and the field</span>
<span class="sd">            already exists, a `ValueError` is raised. Defaults to `False`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unyt.unyt_array</span>
<span class="sd">            The integrated mass profile with appropriate units.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `density_field` does not exist in the model or is not defined over the radial (&#39;r&#39;) axis.</span>

<span class="sd">        KeyError</span>
<span class="sd">            If `mass_field` cannot be determined from the configuration and is not provided, or if</span>
<span class="sd">            `mass_unit` is missing.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method assumes that the specified `density_field` is defined over the radial axis (&#39;r&#39;). The</span>
<span class="sd">        integration is performed using the coordinate system&#39;s `integrate_in_shells` method, which should</span>
<span class="sd">        handle the specifics of the geometry.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve and validate the input field. It must be a valid radial field. Additionally, if we cannot locate</span>
        <span class="c1"># a mass field, we need to be given the mass field name and the units.</span>
        <span class="k">if</span> <span class="n">density_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Density field `</span><span class="si">{</span><span class="n">density_field</span><span class="si">}</span><span class="s2">` does not exist in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">density_field</span><span class="p">]</span><span class="o">.</span><span class="n">AXES</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">density_field</span><span class="si">}</span><span class="s2">&#39; is not defined over the radial (&#39;r&#39;) axis.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Grab the density field.</span>
        <span class="n">density_field_name</span> <span class="o">=</span> <span class="n">density_field</span>
        <span class="n">density_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">density_field</span><span class="p">]</span>

        <span class="c1"># Look for a mass field / mass units. If we cannot find them, we need to raise errors.</span>
        <span class="k">if</span> <span class="n">mass_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We didn&#39;t get a mass field so we need to look it up and try to grab the default units.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mass_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fields.</span><span class="si">{</span><span class="n">density_field_name</span><span class="si">}</span><span class="s2">.mass_field&quot;</span><span class="p">]</span>
                <span class="n">mass_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_units</span><span class="p">(</span><span class="n">mass_field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Mass field for &#39;</span><span class="si">{</span><span class="n">density_field_name</span><span class="si">}</span><span class="s2">&#39; could not be found in configuration or was &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;missing units / reference to a mass field.</span><span class="se">\n</span><span class="s2">If it is not configured, it should be provided manually.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mass_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We still need to look up the mass unit.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mass_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_units</span><span class="p">(</span><span class="n">mass_field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Mass field for &#39;</span><span class="si">{</span><span class="n">density_field_name</span><span class="si">}</span><span class="s2">&#39; could not be found in configuration or was &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;missing units.</span><span class="se">\n</span><span class="s2">If it is not configured, it should be provided manually.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We have everything provided by the input arguments.</span>
            <span class="k">pass</span>

        <span class="c1"># Construct the coordinates, build the interpolated spline and then</span>
        <span class="c1"># perform the shell integration routine. This should be adaptable</span>
        <span class="c1"># for any radial coordinate system due to the implementation of</span>
        <span class="c1"># integrate_in_shells.</span>
        <span class="n">radii</span><span class="p">,</span> <span class="n">spline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radii</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_radial_spline</span><span class="p">(</span>
            <span class="n">density_field_name</span>
        <span class="p">)</span>

        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="c1"># We can skip inspection here because we know coordinate system is a subclass of CoordinateSystem.</span>
        <span class="n">enclosed_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">integrate_in_shells</span><span class="p">(</span><span class="n">spline</span><span class="p">,</span> <span class="n">radii</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>

        <span class="c1"># Manage the boundary estimate. We assume constant density and perform a second integrate in shells to</span>
        <span class="c1"># obtain the total enclosed.</span>
        <span class="n">interior_density</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">radii</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_r</span><span class="p">:</span> <span class="n">interior_density</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">_r</span><span class="p">)</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="n">enclosed_mass</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">integrate_in_shells</span><span class="p">(</span>
            <span class="n">integrand</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">radii</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Manage the units. We compute `mass_units` which is the natural unit of the</span>
        <span class="c1"># computation and then covert to a target unit.</span>
        <span class="n">base_mass_unit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">density_field</span><span class="o">.</span><span class="n">units</span> <span class="o">*</span> <span class="n">unyt</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">length_unit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="p">)</span>
        <span class="n">enclosed_mass</span> <span class="o">=</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">(</span><span class="n">enclosed_mass</span><span class="p">,</span> <span class="n">base_mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">mass_unit</span><span class="p">)</span>

        <span class="c1"># Optionally add the computed mass field to the field container</span>
        <span class="k">if</span> <span class="n">create_field</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="n">mass_field</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">enclosed_mass</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">mass_unit</span><span class="p">),</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">enclosed_mass</span>

    <span class="k">def</span> <span class="nf">compute_spherical_density_from_mass</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mass_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">density_field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">density_unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">unyt</span><span class="o">.</span><span class="n">Unit</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differentiate a radial mass field to compute the density profile.</span>

<span class="sd">        This method takes a specified radial mass field (e.g., gas, stellar, dark matter mass),</span>
<span class="sd">        differentiates it over the radial grid, and computes the enclosed density profile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mass_field : str</span>
<span class="sd">            Name of the mass field to integrate. Must be one of:</span>
<span class="sd">            [&#39;total_mass&#39;, &#39;gas_mass&#39;, &#39;stellar_mass&#39;, &#39;dark_matter_mass&#39;].</span>

<span class="sd">        density_field : str, optional</span>
<span class="sd">            Name of the density field to create. If not provided, it is retrieved from the model&#39;s</span>
<span class="sd">            configuration under by searching for a corresponding field linked to the ``mass_field``.</span>

<span class="sd">        density_unit : str or unyt.Unit, optional</span>
<span class="sd">            Units for the density field. If not provided, it is retrieved from the model&#39;s configuration</span>
<span class="sd">            under `fields.{density_field}.unit`.</span>

<span class="sd">        create_field : bool, default=False</span>
<span class="sd">            If `True`, the density field will be added to the model&#39;s field container (`self.FIELDS`).</span>
<span class="sd">            Defaults to `False`.</span>

<span class="sd">        overwrite : bool, default=False</span>
<span class="sd">            If `True`, overwrite an existing density field with the same name. If `False` and the field</span>
<span class="sd">            already exists, a `ValueError` is raised. Defaults to `False`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        unyt.unyt_array</span>
<span class="sd">            The density profile with appropriate units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve and validate the input field. It must be a valid radial field. Additionally, if we cannot locate</span>
        <span class="c1"># a mass field, we need to be given the mass field name and the units.</span>
        <span class="k">if</span> <span class="n">mass_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mass field `</span><span class="si">{</span><span class="n">mass_field</span><span class="si">}</span><span class="s2">` does not exist in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">mass_field</span><span class="p">]</span><span class="o">.</span><span class="n">AXES</span><span class="p">)</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">mass_field</span><span class="si">}</span><span class="s2">&#39; is not defined over the radial (&#39;r&#39;) axis.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;SphericalCoordinateSystem&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The `compute_spherical_density_from_mass` method only works for SphericalCoordinateSystems.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Grab the mass field.</span>
        <span class="n">mass_field_name</span> <span class="o">=</span> <span class="n">mass_field</span>
        <span class="n">mass_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">mass_field</span><span class="p">]</span>

        <span class="c1"># Look for a density field / density units. If we cannot find them, we need to raise errors.</span>
        <span class="k">if</span> <span class="n">density_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We didn&#39;t get a density field so we need to look it up and try to grab the default units.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_valid_dfields</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">field</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fields.</span><span class="si">{field}</span><span class="s2">.mass_field&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mass_field_name</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_valid_dfields</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>

                <span class="n">density_field</span> <span class="o">=</span> <span class="n">_valid_dfields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">density_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_units</span><span class="p">(</span><span class="n">density_field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Mass field for &#39;</span><span class="si">{</span><span class="n">density_field</span><span class="si">}</span><span class="s2">&#39; could not be found in configuration or was &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;missing units / reference to a density field. </span><span class="se">\n</span><span class="s2">If it is not configured, it should be provided manually.&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">density_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We still need to look up the density unit.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">density_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_units</span><span class="p">(</span><span class="n">density_field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Mass field for &#39;</span><span class="si">{</span><span class="n">density_field</span><span class="si">}</span><span class="s2">&#39; could not be found in configuration or was &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;missing units.</span><span class="se">\n</span><span class="s2">If it is not configured, it should be provided manually.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We have everything provided by the input arguments.</span>
            <span class="k">pass</span>

        <span class="c1"># Construct the coordinates, build the interpolated spline and then</span>
        <span class="c1"># perform the shell integration routine. This should be adaptable</span>
        <span class="c1"># for any radial coordinate system due to the implementation of</span>
        <span class="c1"># integrate_in_shells.</span>
        <span class="n">radii</span><span class="p">,</span> <span class="n">spline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radii</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_radial_spline</span><span class="p">(</span><span class="n">density_field</span><span class="p">)</span>

        <span class="c1"># Compute the density by taking the derivative</span>
        <span class="n">density_data</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">radii</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radii</span><span class="o">.</span><span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Manage the units. We compute `mass_units` which is the natural unit of the</span>
        <span class="c1"># computation and then covert to a target unit.</span>
        <span class="n">base_density_unit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mass_field</span><span class="o">.</span><span class="n">units</span> <span class="o">/</span> <span class="n">unyt</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_manager</span><span class="o">.</span><span class="n">length_unit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="p">)</span>
        <span class="n">density_data</span> <span class="o">=</span> <span class="n">unyt</span><span class="o">.</span><span class="n">unyt_array</span><span class="p">(</span><span class="n">density_data</span><span class="p">,</span> <span class="n">base_density_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">density_unit</span><span class="p">)</span>

        <span class="c1"># Optionally add the computed mass field to the field container</span>
        <span class="k">if</span> <span class="n">create_field</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FIELDS</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="n">density_field</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">density_data</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">density_unit</span><span class="p">),</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">density_data</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Eliza Diggins.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>